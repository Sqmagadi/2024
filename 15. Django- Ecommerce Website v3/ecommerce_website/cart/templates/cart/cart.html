{% extends 'store/base.html' %}


{% block title %}
    cart
{% endblock title %}
    


{% block content %}
<div class="cart-container">
    <table>
        <div class="continue-shopping">
            <a href="{% url 'home' %}"><button>&larr; Continue Shopping</button></a>
        </div>
        <hr>
        {% if cart_items %}
        <thead>
            <tr>
                <th>Items: <strong>{{ total_quantity }}</strong></th>
                <th>Total: <strong>$ {{ order_total }}</strong></th>
                
                {% if user.is_authenticated %}
                <th class="checkout"><a href="{% url 'checkout' %}"><button type="button">Checkout</button></a></th>
                {% else %}
                <th class="checkout"><a href="{% url 'login' %}"><button type="button">Checkout</button></a></th>
                {% endif %}
                    
            </tr>
        </thead>
        {% endif %}
    </table>

    <div class="cart-elements-container">
        {% if cart_items %}
        <div class="cart-element-header">
            <div class="cart-item-image"></div>
            <div class="cart-item-name"><strong>Item</strong></div>
            <div class="cart-item-quantity"><strong>Quantity</strong></div>
            <div class="cart-item-price"><strong>Price</strong></div>
            <div class="cart-item-total"><strong>Total</strong></div>
        </div>
        <hr>

        {% endif %}
            <div class="cart-element">
                {% if cart_items %}
                    {% for item in cart_items %}
                        <div class="cart-item-image"><img src="{{ item.imageURL }}" alt="" width="100%"></div>
                        <div class="cart-item-name">{{ item.name }}</div>
                        <div class="cart-item-quantity"> 
                            <button class="minus-btn" data-id="{{ item.id }}" style="padding: .3em .5em;">&minus;</button>
                            <span>{{ item.quantity }}</span>
                            <button class="plus-btn" data-id="{{ item.id }}" style="padding: .3em .5em;">&plus;</button>
                        </div>
            
            {% if item.is_sale %}
            <div class="cart-item-price">$ {{item.sale_price}}</div>
            {% else %}
            <div class="cart-item-price">$ {{item.price}}</div> 
            {% endif %}
            <div class="cart-item-total">$ {{item.total_price}}</div>
            {% endfor %}
            {% else %}
            <br><br><br><br><br><br>
            <h1>Nothing in your cart... <a href="{% url 'home' %}">Continue Shopping</a></h1>
            {% endif %}
        </div>
        
   
    </div>
</div>

<script>
    // Function to handle plus button click
    $(document).on('click', '.plus-btn', function(e){
        e.preventDefault();
        var itemId = $(this).data('id'); // Get the data-id attribute of the clicked button (item ID)
        var quantityElement = $(this).siblings('span'); // Get the adjacent span element containing the quantity

        // Send AJAX request to update item quantity
        $.ajax({
            type: 'POST',
            url: '{% url "cart_update" %}', // Replace "cart_update" with your actual URL name
            data: {
                item_id: itemId,
                new_quantity: parseInt(quantityElement.text()) + 1, // Increment quantity by 1
                csrfmiddlewaretoken: '{{ csrf_token }}',
            },
            success: function(response){
                // Update quantity display on success
                quantityElement.text(parseInt(quantityElement.text()) + 1);
            },
            error: function(xhr, errmsg, err){
                // Handle error
            }
        });
    });

    // Function to handle minus button click
    $(document).on('click', '.minus-btn', function(e){
        e.preventDefault();
        var itemId = $(this).data('id'); // Get the data-id attribute of the clicked button (item ID)
        var quantityElement = $(this).siblings('span'); // Get the adjacent span element containing the quantity

        // Send AJAX request to update item quantity
        $.ajax({
            type: 'POST',
            url: '{% url "cart_update" %}', // Replace "cart_update" with your actual URL name
            data: {
                item_id: itemId,
                new_quantity: Math.max(parseInt(quantityElement.text()) - 1, 0), // Decrement quantity by 1 (ensure it doesn't go below 0)
                csrfmiddlewaretoken: '{{ csrf_token }}',
            },
            success: function(response){
                // Update quantity display on success
                quantityElement.text(Math.max(parseInt(quantityElement.text()) - 1, 0));
            },
            error: function(xhr, errmsg, err){
                // Handle error
            }
        });
    });
</script>



{% endblock content %}
    