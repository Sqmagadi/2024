{% extends 'store/base.html' %}


{% block title %}
    cart
{% endblock title %}
    


{% block content %}
<div class="cart-container">
    <table>
        <div class="continue-shopping">
            <a href="{% url 'home' %}"><button>&larr; Continue Shopping</button></a>
        </div>
        <hr>
        {% if cart_items %}
        <thead>
            <tr>
                <th>Items: <strong>{{ total_quantity }}</strong></th>
                <th>Total: <strong>$ {{ order_total }}</strong></th>
                
                {% if user.is_authenticated %}
                <th class="checkout"><a href="{% url 'checkout' %}"><button type="button">Checkout</button></a></th>
                {% else %}
                <th class="checkout"><a href="{% url 'login' %}"><button type="button">Checkout</button></a></th>
                {% endif %}
                    
            </tr>
        </thead>
        {% endif %}
    </table>

    <div class="cart-elements-container">
        {% if cart_items %}
        <div class="cart-element-header">
            <div class="cart-item-image"></div>
            <div class="cart-item-name"><strong>Item</strong></div>
            <div class="cart-item-quantity"><strong>Quantity</strong></div>
            <div class="cart-item-price"><strong>Price</strong></div>
            <div class="cart-item-total"><strong>Total</strong></div>
        </div>
        <hr>

        {% endif %}
            <div class="cart-element">
                {% if cart_items %}
                    {% for item in cart_items %}
                        <div class="cart-item-image"><img src="{{ item.imageURL }}" alt="" width="100%"></div>
                        <div class="cart-item-name">{{ item.name }}</div>
                        <div class="cart-item-quantity"> 
                            <button class="minus-btn" data-id="{{ item.id }}" style="padding: .3em .5em;">&minus;</button>
                            <span>{{ item.quantity }}</span>
                            <button class="plus-btn" data-id="{{ item.id }}" style="padding: .3em .5em;">&plus;</button>
                        </div>
            
            {% if item.is_sale %}
            <div class="cart-item-price">$ {{item.sale_price}}</div>
            {% else %}
            <div class="cart-item-price">$ {{item.price}}</div> 
            {% endif %}
            <div class="cart-item-total">$ {{item.total_price}}</div>
            {% endfor %}
            {% else %}
            <br><br><br><br><br><br>
            <h1>Nothing in your cart... <a href="{% url 'home' %}">Continue Shopping</a></h1>
            {% endif %}
        </div>
        
   
    </div>
</div>



<script>
    // Function to handle quantity update
    function updateQuantity(productId, newQuantity) {
        fetch(`/update-cart-item/${productId}/${newQuantity}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'  // Ensure to include the CSRF token
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Update the quantity displayed on the page
            document.querySelector(`[data-id="${productId}"]`).innerText = newQuantity;
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    // Add event listeners to plus and minus buttons
    document.querySelectorAll('.plus-btn').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-id');
            const currentQuantity = parseInt(this.nextElementSibling.innerText);
            const newQuantity = currentQuantity + 1;
            updateQuantity(productId, newQuantity);
        });
    });

    document.querySelectorAll('.minus-btn').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-id');
            const currentQuantity = parseInt(this.previousElementSibling.innerText);
            if (currentQuantity > 1) {
                const newQuantity = currentQuantity - 1;
                updateQuantity(productId, newQuantity);
            }
        });
    });
</script>

{% endblock content %}
    